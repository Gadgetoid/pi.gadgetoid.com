Raphael.fn.roundedRectangle=function(e,t,n,r,i,s,o,u){var a=[];a=a.concat(["M",e,i+t,"Q",e,t,e+i,t]);a=a.concat(["L",e+n-s,t,"Q",e+n,t,e+n,t+s]);a=a.concat(["L",e+n,t+r-o,"Q",e+n,t+r,e+n-o,t+r]);a=a.concat(["L",e+u,t+r,"Q",e,t+r,e,t+r-u,"Z"]);return this.path(a)};var game={map:[],pending:[],colours:[[42,161,152],[220,50,47],[211,54,130],[108,113,196],[133,153,0]],colour_count:[],settings:{canvas:"game",dots:null,dot_radius:20,dot_spacing:4,initial_delay:1e3,background:[7,54,66],path:[236,240,241],text:[255,255,255],time:10,debug:false,diagonal:false,horizontal:true,vertical:true,eliminate:false},score:{display:null,total:0,time_left:0,running:false,stats:{total_moves:0,removed:[]}},state:{origin:null,waypoints:[],columns_to_update:[],paused:false},fn:{}};game.fn.vector=function(e,t){return{x:e,y:t}};game.settings.dots=game.fn.vector(0,0);game.state.origin=game.fn.vector(0,0);var debug_output=document.getElementById("debug");var score_output=document.getElementById("score");game.fn.show_score=function(){game.score.results.toFront()};game.fn.log_score=function(e){var t=game.score.log.attr("text");game.score.log.attr({text:e+"\n"+"You scored: "+game.score.total+"\n"+t})};game.fn.debug=function(e){if(game.settings.debug)debug_output.innerHTML=e+"\n"+debug_output.innerHTML};game.fn.rgb=function(e){return"rgb("+e.join(",")+")"};game.fn.rgba=function(e,t){return"rgba("+e.join(",")+","+t+")"};game.fn.rgbl=function(e,t){var n=[0,0,0];for(var r in e){n[r]=e[r];n[r]+=t;if(n[r]>255)n[r]=255}return"rgb("+n.join(",")+")"};game.fn.update_drag_path=function(){game.state.drag_path.attr({drag_path:[game.state.origin.x,game.state.origin.y,game.state.waypoints,game.state.drag.x,game.state.drag.y]})};game.fn.dot_mouseout=function(){var e=game.colours[this.data("colour")];this.animate({fill:rgb(e)},200)};game.fn.dot_mouseover=function(){var e=game.colours[this.data("colour")];this.animate({fill:rgbl(e,100)},200)};game.fn.animate_to_position=function(e){x=e.data("position").x;y=e.data("position").y;game.map[x+":"+y]=e;game.fn.debug("Updating dot map at: "+e.data("position").x+":"+e.data("position").y);e.data("coordinates").x=(e.data("position").x+1)*(game.settings.dot_radius*2+game.settings.dot_spacing)-game.settings.dot_radius;e.data("coordinates").y=(e.data("position").y+1)*(game.settings.dot_radius*2+game.settings.dot_spacing)-game.settings.dot_radius;e.stop().animate({cx:e.data("coordinates").x,cy:e.data("coordinates").y},e.data("delay"),"bounce")};game.fn.unpause=function(){game.state.paused=false};game.fn.end=function(e){game.state.paused=true;clearInterval(game.score.timer);setTimeout(game.fn.unpause,2e3);game.score.started=false;for(var t in game.state.waypoints){game.state.waypoints[t].attr({fill:game.fn.rgb(game.colours[game.state.waypoints[t].data("colour")])})}game.fn.log_score(e);game.fn.show_score()};game.fn.countdown=function(){game.score.time_left-=1;game.score.time.attr({text:game.score.time_left});if(game.score.time_left<=0){game.fn.end("Time up!")}};game.fn.check_legal_moves=function(){var e=false;game.dots.forEach(function(t,n){var r=t.data("colour");var i=game.fn.check_positions(t.data("position"));while(element=i.pop()){if(element.data("colour")==r){e=true;break}}});if(!e)game.fn.end("No legal moves!")};game.fn.dot_onstart=function(e,t){if(game.state.paused)return;if(!game.score.started){game.score.total=0;game.score.started=true;game.score.time_left=game.settings.time;game.score.time.attr({text:game.score.time_left});game.score.timer=setInterval(game.fn.countdown,1e3)}game.state.origin=this.data("coordinates");game.state.origin.dot=this.data("position");game.state.waypoints.push(this);game.state.colour=this.data("colour");game.fn.debug(game.state.origin.dot.x+":"+game.state.origin.dot.y)};game.fn.check_positions=function(e){var t=[];if(game.settings.horizontal){t.push(game.fn.vector(e.x-1,e.y));t.push(game.fn.vector(e.x+1,e.y))}if(game.settings.vertical){t.push(game.fn.vector(e.x,e.y-1));t.push(game.fn.vector(e.x,e.y+1))}if(game.settings.diagonal){t.push(game.fn.vector(e.x-1,e.y-1));t.push(game.fn.vector(e.x-1,e.y+1));t.push(game.fn.vector(e.x+1,e.y-1));t.push(game.fn.vector(e.x+1,e.y+1))}var n=[];for(e in t){if((found_dot=game.fn.dot_at_position(t[e]))!=false&&game.state.waypoints.indexOf(found_dot)==-1){n.push(found_dot)}}return n};game.fn.dot_onmove=function(e,t){if(game.state.paused)return;e+=game.state.origin.x;t+=game.state.origin.y;game.state.drag=game.fn.vector(e,t);var n=game.state.waypoints[game.state.waypoints.length-1];var r=n.data("position");var i=game.fn.check_positions(r);while(element=i.pop()){if(element.data("colour")==game.state.colour&&e>element.data("coordinates").x-game.settings.dot_radius-game.settings.dot_spacing/3&&e<element.data("coordinates").x+game.settings.dot_radius+game.settings.dot_spacing/3&&t>element.data("coordinates").y-game.settings.dot_radius-game.settings.dot_spacing/3&&t<element.data("coordinates").y+game.settings.dot_radius+game.settings.dot_spacing/3){element.attr({fill:game.fn.rgbl(game.colours[element.data("colour")],70)});game.state.waypoints.push(element);for(var s in game.state.waypoints){game.state.waypoints[s].stop().animate({fill:game.fn.rgbl(game.colours[game.state.waypoints[s].data("colour")],2*game.state.waypoints.length*game.state.waypoints.length)},0)}i=[];check_positions=[];return true}}game.fn.update_drag_path()};game.fn.dot_onend=function(){if(game.state.paused)return;if(game.state.waypoints.length>1){for(var e in game.state.waypoints){game.score.stats.removed[game.state.waypoints[e].data("colour")]+=1;game.state.waypoints[e].attr({fill:game.fn.rgb(game.colours[game.state.waypoints[e].data("colour")])});game.fn.dot_remove(game.state.waypoints[e])}game.fn.dots_update();game.score.total+=game.state.waypoints.length*game.state.waypoints.length*game.state.waypoints.length;game.score.stats.total_moves+=1;game.score.display.attr({text:game.score.total});game.fn.check_legal_moves()}game.state.waypoints=[];game.state.origin=game.fn.vector(0,0);game.state.origin.dot=game.fn.vector(0,0);game.state.drag=game.fn.vector(0,0);game.state.colour=-1;game.fn.update_drag_path()};game.fn.get_dot_index=function(e){var t=e;var n=-1;game.dots.forEach(function(e,r){if(e==t){n=r}});return n};game.fn.dot_at_position=function(e){var t=false;t=game.map[e.x+":"+e.y];if(typeof t=="object"&&t!==null){return t}else{return false}};game.fn.dots_update=function(){while((x=game.state.columns_to_update.pop())!=null){var e=false;game.fn.debug("Updating column: "+x);for(y=game.settings.dots.y-2;y>=0;y--){var t=game.fn.dot_at_position(game.fn.vector(x,y));if(t!=false){var n=game.fn.dot_at_position(game.fn.vector(x,y+1));if(n==false){pos=t.data("position");game.map[pos.x+":"+pos.y]=null;game.fn.debug("Removing dot at: "+pos.x+":"+pos.y);t.data("position").y+=1;t.data({delay:1e3});game.fn.animate_to_position(t);e=true}}}if((t=game.pending[x].pop())!=null){game.fn.debug("Found dot at top of column: "+x);t.data("position").y=0;t.data({delay:1e3});var r=game.fn.get_new_colour(game.eliminate);t.attr({fill:game.fn.rgb(game.colours[r])});t.data({colour:r});game.fn.animate_to_position(t);e=true}if(e)game.state.columns_to_update.push(x)}};game.fn.dot_remove=function(e){game.fn.debug("Removing dot at: "+e.data("position").x+":"+e.data("position").y);x=e.data("position").x;y=e.data("position").y;game.map[x+":"+y]=null;game.colour_count[e.data("colour")]-=1;game.pending[x].push(e);e.data("position").y=-1;e.data("coordinates").y=game.state.dot_start_y;if(game.state.columns_to_update.indexOf(e.data("position").x)==-1){game.state.columns_to_update.push(e.data("position").x)}e.attr({cy:game.state.dot_start_y})};game.fn.get_new_colour=function(e){var t=-1;var n=game.colours.length*2,r=0;while(t=-1&&r<n){var i=Math.floor(Math.random()*game.colours.length);if(game.colour_count[i]>0||e==false){game.colour_count[i]+=1;t=i;return t}r++}return game.fn.get_new_colour(false)};game.fn.reset=function(){game.state.waypoints=[];game.state.origin=game.fn.vector(0,0);game.state.origin.dot=game.fn.vector(0,0);game.state.drag=game.fn.vector(0,0);game.state.colour=-1;game.fn.update_drag_path();for(var e=0;e<game.colours.length;e++){game.colour_count[e]=0;game.score.stats.removed[e]=0}game.dots.forEach(function(e,t){n=e.data("position").x;r=e.data("position").y;game.map[n+":"+r]=null;game.pending[n].push(e);e.data("position").y=-1;e.data("coordinates").y=game.state.dot_start_y-10;e.attr({cy:game.state.dot_start_y-10})});var t=0;for(var n=0;n<game.settings.dots.x;n++){for(var r=0;r<game.settings.dots.y;r++){dot=game.pending[n].pop();dot_x=n*(game.settings.dot_radius*2+game.settings.dot_spacing)+game.settings.dot_spacing+game.settings.dot_radius;dot_y=r*(game.settings.dot_radius*2+game.settings.dot_spacing)+game.settings.dot_spacing+game.settings.dot_radius;var i=game.fn.get_new_colour(false);dot.data({colour:i,position:game.fn.vector(n,r),coordinates:game.fn.vector(dot_x,dot_y),delay:0}).attr({fill:game.fn.rgb(game.colours[i]),cx:dot_x,cy:game.state.dot_start_y});dot.animate({cy:game.state.dot_start_y},game.settings.initial_delay-(t+n),function(){dot_y=this.data("coordinates").y;this.animate({cy:dot_y},1e3,"bounce")});game.map[n+":"+r]=dot;t+=game.state.in_delay}}};game.start=function(){game.state.dot_start_y=-game.settings.dot_radius-game.settings.dot_spacing;game.state.in_delay=game.settings.initial_delay/game.settings.dots.y/game.settings.dots.x;var e=game.settings.dot_radius+game.settings.dot_spacing+5;game_width=game.settings.dots.x*game.settings.dot_radius*2+game.settings.dot_spacing*(game.settings.dots.x+1);game_height=game.settings.dots.y*game.settings.dot_radius*2+game.settings.dot_spacing*(game.settings.dots.y+1);game.paper=Raphael(document.getElementById(game.settings.canvas),game_width,game_height+50);game.paper.text(0,game_height+20,"score:").attr({"text-anchor":"start","font-size":16});game.score.display=game.paper.text(60,game_height+20,"0").attr({"text-anchor":"start","font-size":16});game.score.time=game.paper.text(game_width,game_height+20,"0").attr({"text-anchor":"end","font-size":16});game.paper.customAttributes.arc=function(e,t,n,r,i){var s=360/r*n,o=(90-s)*Math.PI/180,u=e+i*Math.cos(o),a=t-i*Math.sin(o),f;if(r==n){f=[["M",e,t-i],["A",i,i,0,1,1,e-.01,t-i]]}else{f=[["M",e,t-i],["A",i,i,0,+(s>180),1,u,a]]}return{path:f}};game.paper.customAttributes.drag_path=function(e,t,n,r,i){if(n.length>0){player_path=[];player_path.push(["m",n[0].data("coordinates").x,n[0].data("coordinates").y]);for(var s=1;s<n.length;s++){player_path.push([n[s].data("coordinates").x,n[s].data("coordinates").y])}player_path.push([r,i]);return{path:player_path}}else{return{path:[["m",0,0],[0,0]]}}};game_bg=game.paper.roundedRectangle(0,0,game_width,game_height,e,e,e,e);game_bg.attr({fill:game.fn.rgb(game.settings.background),stroke:"none"});game.paper.setStart();for(var t=0;t<game.settings.dots.x;t++){game.pending[t]=[];for(var n=0;n<game.settings.dots.y;n++){game.paper.circle(0,game.state.dot_start_y,game.settings.dot_radius).attr({fill:"#FFFFFF",stroke:"transparent","stroke-width":game.settings.dot_spacing}).data({colour:-1,position:game.fn.vector(t,n),coordinates:game.fn.vector(0,game.state.dot_start_y),delay:0})}}game.dots=game.paper.setFinish();var r=game.settings.dot_spacing+game.settings.dot_radius;game.paper.setStart();game.score.score_results_bg=game.paper.roundedRectangle(0,0,game_width,game_height,e,e,e,e);game.score.score_results_bg.attr({fill:game.fn.rgba(game.settings.background,.8),stroke:"none"});game.score.log=game.paper.text(r,game_height/2).attr({"text-anchor":"start",fill:game.fn.rgb(game.settings.text),"font-size":12});game.score.log.attr({text:"Hello, you have "+game.settings.time+" seconds"+"\n"+"to clear as many dots as possible."+"\n \n"+"Swipe across dots of the same colour"+"\n"+"to remove them from play."+"\n \n"+"Click to get started!"+"\n \n \n "+"pi.gadgetoid.com"});game.score.results=game.paper.setFinish();game.score.results.click(function(){if(game.state.paused)return;game.score.log.attr({text:"","font-size":16});game.score.results.toBack();game.score.time.attr({text:"0"});game.score.display.attr({text:"0"});game.fn.reset()});game.score.results.drag(function(){},function(){if(game.state.paused)return;game.score.log.attr({text:"","font-size":16});game.score.results.toBack();game.score.time.attr({text:"0"});game.score.display.attr({text:"0"});game.fn.reset()},function(){});game_bg.drag(function(){},function(){},function(){});game.dots.drag(game.fn.dot_onmove,game.fn.dot_onstart,game.fn.dot_onend);game.state.drag_cursor=game.paper.path().attr({stroke:game.fn.rgb(game.settings.path),"stroke-width":3});game.state.drag_path=game.paper.path().attr({stroke:game.fn.rgb(game.settings.path),"stroke-width":3});game.fn.reset()}